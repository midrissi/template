var config = require('config'),	i18nConf = config.i18n,	defLang = i18nConf['default'],	cookie = require('cookie');function getAcceptedLanguagesFromHeader(header) {	var languages = header.split(','),		preferences = {};	return languages.map(function parseLanguagePreference(item) {		var preferenceParts = item.trim().split(';q=');		if (preferenceParts.length < 2) {			preferenceParts[1] = 1.0;		} else {			var quality = parseFloat(preferenceParts[1]);			preferenceParts[1] = quality ? quality : 0.0;		}		preferences[preferenceParts[0]] = preferenceParts[1];		return preferenceParts[0];	}).filter(function(lang) {		return preferences[lang] > 0;	}).sort(function sortLanguages(a, b) {		return preferences[b] - preferences[a];	});};exports.getLanguage = function(req) {	var res = defLang;	if (req && req.headers) {		if (i18nConf.cookie) {			return cookie.parse(req.headers['COOKIE'])[i18nConf.cookie];		}		if (req.headers['ACCEPT_LANGUAGE']) {			return getAcceptedLanguagesFromHeader(req.headers['ACCEPT_LANGUAGE'] || '');		}	}	return res;};